---
title: "GBLUP"
author: "LucianoRogerio"
date: "2021-10-19"
output: workflowr::wflow_html
editor_options:
  chunk_output_type: console
---

## Introduction

```{r}
library(here); library(sommer); library(reactable); library(tidyverse)

traits<-c("PTR", "PPA", "AP", "DMC", "DRY")

drgphen <- read.table(here::here("output", "DeregressBLUPsAll.CSV"), sep = ";", dec = ".")
A <- readRDS(here::here("output", "KinshipAdd.RDS"))
D <- readRDS(here::here("output", "KinshipDom.RDS"))

drgphen2 <- drgphen[drgphen$CLONE%in%rownames(A),]
drgphen2$Add <- factor(drgphen2$CLONE, levels = rownames(A))

rownames(D) <- paste(rownames(D), "d", sep = ".")
colnames(D) <- paste(colnames(D), "d", sep = ".")

drgphen2$Dom <- factor(paste(drgphen2$CLONE, "d", sep = "."),
                       levels = rownames(D))

## Genomic Prediction using sommer package for the five agronomic traits
ModelResults<-list()
for(i in traits){
    require(sommer)
# Must remove rows where there are missing values for the current trait
drgphen3 <- drgphen2[!is.na(drgphen2[ , i]), ] %>% select(Add, Dom, i, paste(i, "wt", sep = "."))
colnames(drgphen3)[3:4] <- c("trait", "WT")
  
fit <- mmer(fixed = trait ~ 1,
            random = ~ vs(Add, Gu = A) + vs(Dom,Gu = D),
            weights = WT,
            data = drgphen3, getPEV = TRUE)
ModelResults[[i]] <- fit
}

Pred <- data.frame(CLONE = unique(drgphen$CLONE))
for(i in traits){
Res <- data.frame(CLONE = names(ModelResults[[i]]$U$`u:Add`$trait),
                  gebvs = ModelResults[[i]]$U$`u:Add`$trait,
                  gegvs = (ModelResults[[i]]$U$`u:Add`$trait + ModelResults[[i]]$U$`u:Dom`$trait))
colnames(Res)[2:3] <- c(paste(i, "gebvs", sep = "."),
                        paste(i, "gegvs", sep = "."))
Pred <- merge(Pred, Res, by = "CLONE")
}

phen<-read.table(here::here("data", "Dados_Finais_2020_15_locais.csv"), head=T, sep = ";", dec = ".")

TraitsMeans <- colMeans(phen[,8:12], na.rm = T)

PredMat <- as.matrix(Pred[,-1])
PredMean <- data.frame(CLONE = Pred$CLONE,
                       PredMat + 
                         matrix(rep(1, nrow(Pred)),
                                nrow = nrow(Pred))%*%matrix(rep(TraitsMeans,
                                                                each = 2), ncol = 10))
# Table 1. GEBVs and GEGVs plus trait mean estimated for each clone for five agronomic traits
PredMean %>% reactable(defaultPageSize = 25, columns = list(
  PTR.gebvs = colDef(format = colFormat(digits = 2, locales = "en-US")),
  PTR.gegvs = colDef(format = colFormat(digits = 2, locales = "en-US")),
  PPA.gebvs = colDef(format = colFormat(digits = 2, locales = "en-US")),
  PPA.gegvs = colDef(format = colFormat(digits = 2, locales = "en-US")),
  AP.gebvs = colDef(format = colFormat(digits = 2, locales = "en-US")),
  AP.gegvs = colDef(format = colFormat(digits = 2, locales = "en-US")),
  DMC.gebvs = colDef(format = colFormat(digits = 2, locales = "en-US")),
  DMC.gegvs = colDef(format = colFormat(digits = 2, locales = "en-US")),
  DRY.gebvs = colDef(format = colFormat(digits = 2, locales = "en-US")),
  DRY.gegvs = colDef(format = colFormat(digits = 2, locales = "en-US"))))

write.table(PredMean, here::here("output", "GenPred.csv"), sep = ";",
            dec = ".", quote = F)

```

